<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" type="text/css" href="css/styles.css" />
    
<script type="text/javascript" language="javascript">
var table = null;
var restaurantsData = null;

var fieldsToHeader = {
     'name': 'Nombre',
     'url': 'URL',
     'pricing.expectedMealPrice': 'Precio',
     'zone.name': 'Zona'
};
 
    
function send(){
     if(restaurantsData === null){
         restaurantsData = requestData();
     }
    
     var randomIndex = Math.floor(Math.random() * restaurantsData.length);
     var selectedRestaurantJSON = restaurantsData[randomIndex];

     if(table === null){
        table = initTable(Object.keys(fieldsToHeader).map(k => fieldsToHeader[k]));
    }
    
    addRestaurantToTable(Object.keys(fieldsToHeader), selectedRestaurantJSON);
}

function requestData(){
    var corsProxy = 'https://cors-anywhere.herokuapp.com/';
    var url = 'https://buenos-aires.restorando.com.ar/restaurantes-en-martinez,palermo,san-isidro,vicente-lopez,zona-norte/con-precio-4,5';
    var request = new Request(corsProxy + url, {
      method: 'GET', 
      headers: {}
    });
    var response = async () => { 
        var res = await fetch(request);
        response = await res.text();
    }
    var regex = new RegExp('window\.__INITIAL_STATE__ = (.*?);($|\n)');
    var matcher = regex.exec(response);    
    return JSON.parse(matcher[1]).search.restaurants;
}

function initTable(headerNames){
    var table = document.createElement('table');
    var header = table.createTHead();
    var row = header.insertRow(0);  
    var y = 0;
    headerNames.forEach(function(headerName) {
        var cell = row.insertCell(y);
        cell.innerHTML = '<b>' + headerName + '</b>';   
        y++;
    });
    return table;
}
    
function addRestaurantToTable(fieldNames, restaurantData) {

  var row = document.createElement('tr');

  fieldNames.forEach(function(fieldName) {
    var cell = document.createElement('td');      
    var fieldValue = restaurantData[fieldName];

    if(fieldName == 'url'){
       var link = document.createElement("a");
       link.setAttribute("href", fieldValue);
       var linkText = document.createTextNode(fieldValue);
       link.appendChild(linkText);
       cell.appendChild(link);
    } else if(fieldName.includes('.')){ //??????????????
       var nestedFields = fieldName.split('.');
       var finalValue;
       var currentJSON = restaurantData;
       nestedFields.forEach(function(currentNestedField, index){
          currentJSON = currentJSON[currentNestedField];
          if(index == (nestedFields.length - 1)){
             finalValue = currentJSON;
          }          
       });
        
       cell.appendChild(document.createTextNode(finalValue));
    } else {
       cell.appendChild(document.createTextNode(fieldValue));
    }

    row.appendChild(cell);
  });
  
  var tableBody = document.createElement('tbody'); //??
  tableBody.appendChild(row);
  table.appendChild(tableBody);
  document.getElementById("div").appendChild(table);
}

</script>
</head>

<body>
    <button class="btn_c" type="submit" onclick="javascript:send()">Buscar</button>
    <div id="div" class="div_c"></div>
</body>
</html>
